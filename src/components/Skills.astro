---
import { parseSkillsMarkdown } from '../utils/parseSkills';
import { parseCertifications } from '../utils/parseCertifications';
import { resolve } from 'path';

// Parse skills.md at build time
const skillsPath = resolve('./src/resources/skills.md');
const categories = parseSkillsMarkdown(skillsPath);

// Parse certifications.md at build time
const certificationsPath = resolve('./src/resources/certifications.md');
const certifications = parseCertifications(certificationsPath);
---

<section id="skills" class="skills-section py-24 px-6 bg-bg-secondary">
  <div class="max-w-content mx-auto">
    <div class="section-header animate-on-scroll">
      <span class="header-bracket">[</span>
      <h2 class="text-3xl md:text-4xl font-bold text-text">Skills</h2>
      <span class="header-bracket">]</span>
    </div>

    <div class="skills-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {categories.map(({ name, icon, subsections }) => (
        <div
          class="skill-card-wrapper"
          role="button"
          tabindex="0"
          aria-expanded="false"
          aria-label={`${name} skills category`}
        >
          <!-- Category card with dropdown -->
          <div class="skill-card terminal-card group cursor-pointer h-full">
            <!-- Card header -->
            <div class="p-6 flex flex-col items-center gap-3">
              <i data-lucide={icon} class="w-10 h-10 text-accent skill-icon"></i>
              <h3 class="text-lg font-semibold text-text text-center font-display">{name}</h3>
              <p class="text-xs text-text-secondary opacity-70 font-mono terminal-hint">
                <span class="hint-bracket">&gt;</span> Hover to expand
              </p>
            </div>

            <!-- Dropdown panel with subsections -->
            {subsections.length > 0 && (
              <div class="skill-panel absolute top-full left-0 right-0 mt-2 p-4 bg-bg-secondary rounded border border-accent/30 shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 backdrop-blur-lg">
                <div class="space-y-2 max-h-96 overflow-y-auto">
                  {subsections.map(({ name: subsectionName, skills }) => (
                    <div class="subsection-item">
                      <button
                        class="subsection-toggle w-full text-left flex items-center justify-between gap-2 p-2 rounded hover:bg-bg transition-colors"
                        aria-expanded="false"
                      >
                        <span class="text-sm font-semibold text-accent flex items-start gap-2">
                          <span class="mt-0.5">&gt;</span>
                          <span>{subsectionName}</span>
                        </span>
                        <svg
                          class="chevron w-4 h-4 text-accent transition-transform"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                      </button>
                      <div class="subsection-skills hidden pl-6 pr-2 py-2 space-y-1">
                        {skills.map((skill) => (
                          <div class="text-xs text-text-secondary font-mono flex items-start gap-2">
                            <span class="text-accent-hover mt-0.5">â€¢</span>
                            <span>{skill}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      ))}

      <!-- Certifications Card -->
      {certifications.length > 0 && (
        <div
          class="skill-card-wrapper"
          role="button"
          tabindex="0"
          aria-expanded="false"
          aria-label="Certifications"
        >
          <div class="skill-card terminal-card group cursor-pointer h-full">
            <!-- Card header -->
            <div class="p-6 flex flex-col items-center gap-3">
              <i data-lucide="award" class="w-10 h-10 text-accent skill-icon"></i>
              <h3 class="text-lg font-semibold text-text text-center font-display">Certifications</h3>
              <p class="text-xs text-text-secondary opacity-70 font-mono terminal-hint">
                <span class="hint-bracket">&gt;</span> Hover to expand
              </p>
            </div>

            <!-- Dropdown panel with certifications -->
            <div class="skill-panel absolute top-full left-0 right-0 mt-2 p-4 bg-bg-secondary rounded border border-accent/30 shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 backdrop-blur-lg">
              <ul class="space-y-3 max-h-96 overflow-y-auto">
                {certifications.map((cert) => (
                  <li class="cert-item">
                    <a
                      href={cert.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="block p-3 rounded border border-border hover:border-accent transition-colors"
                    >
                      <div class="flex items-start justify-between gap-2 mb-2">
                        <span class="text-sm font-semibold text-text flex-1">{cert.name}</span>
                        <svg
                          class="w-4 h-4 text-accent flex-shrink-0 mt-0.5"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                      </div>
                      <div class="flex items-center gap-4 text-xs text-text-secondary font-mono">
                        <span>Issued: {cert.issueDate}</span>
                        <span>Expires: {cert.expirationDate}</span>
                      </div>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      )}
    </div>
  </div>
</section>

<style>
  /* Ensure dropdowns don't get clipped and can overflow into next section */
  .skills-section {
    overflow: visible;
    position: relative;
    z-index: 10; /* Above Contact section (z-1) */
  }

  /* Increase z-index when any card is hovered */
  .skills-section:has(.skill-card-wrapper:hover),
  .skills-section:has(.skill-card.is-active) {
    z-index: 9999; /* Bring entire section above everything when dropdown is active */
  }

  .skills-grid {
    overflow: visible;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 3rem;
  }

  .header-bracket {
    font-family: var(--font-display);
    font-size: 3rem;
    color: var(--color-accent);
    font-weight: 900;
  }

  .skill-icon {
    filter: drop-shadow(0 0 10px var(--color-glow));
    transition: all 0.3s ease;
  }

  .skill-card:hover .skill-icon {
    transform: scale(1.1) rotateY(180deg);
    filter: drop-shadow(0 0 20px var(--color-glow));
  }

  .terminal-hint {
    transition: all 0.3s ease;
  }

  .hint-bracket {
    color: var(--color-accent);
    font-weight: 700;
  }

  .skill-card:hover .terminal-hint {
    color: var(--color-accent);
  }

  .skill-panel {
    box-shadow: 0 10px 40px var(--color-glow);
    z-index: 9999; /* Ensure panels appear above all content */
  }

  .subsection-item {
    border-bottom: 1px solid var(--color-border);
  }

  .subsection-item:last-child {
    border-bottom: none;
  }

  .subsection-toggle {
    user-select: none;
  }

  .subsection-toggle[aria-expanded="true"] .chevron {
    transform: rotate(180deg);
  }

  .subsection-skills {
    animation: slideDown 0.2s ease;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      max-height: 0;
    }
    to {
      opacity: 1;
      max-height: 500px;
    }
  }

  .cert-item a:hover {
    background: var(--color-bg);
  }

  .skill-card-wrapper {
    position: relative;
  }

  .skill-card {
    position: relative;
    min-height: 200px;
  }

  /* Desktop: hover shows panel */
  @media (hover: hover) {
    .skill-card:hover {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
  }

  /* Mobile: click toggles .is-active class */
  @media (hover: none) {
    .skill-panel {
      opacity: 0 !important;
      visibility: hidden !important;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .skill-card.is-active .skill-panel {
      opacity: 1 !important;
      visibility: visible !important;
    }
  }

  /* Focus states for accessibility */
  .skill-card-wrapper:focus-within {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
    border-radius: 4px;
  }

  /* Ensure hovered/active cards appear above others and next section */
  .skill-card-wrapper:hover,
  .skill-card-wrapper:focus-within,
  .skill-card-wrapper:has(.is-active) {
    z-index: 9998; /* Just below panel (z-9999) but above everything else */
  }

  /* Custom scrollbar for dropdown panels */
  .skill-panel {
    scrollbar-width: thin;
    scrollbar-color: var(--color-accent) transparent;
  }

  .skill-panel::-webkit-scrollbar {
    width: 6px;
  }

  .skill-panel::-webkit-scrollbar-track {
    background: transparent;
  }

  .skill-panel::-webkit-scrollbar-thumb {
    background-color: var(--color-accent);
    border-radius: 3px;
  }

  .skill-panel::-webkit-scrollbar-thumb:hover {
    background-color: var(--color-accent-hover);
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .skill-panel,
    .skill-card,
    .skill-icon,
    .subsection-skills {
      transition: none;
      animation: none;
    }
  }

  /* Hide data-lucide elements until Lucide initializes them */
  [data-lucide]:not(.lucide) {
    opacity: 0.3;
  }
</style>

<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest" is:inline></script>
<script is:inline>
  lucide.createIcons();
</script>

<!-- Subsection toggle functionality -->
<script>
  document.querySelectorAll('.subsection-toggle').forEach(toggle => {
    toggle.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent card from closing
      const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
      const skillsDiv = toggle.nextElementSibling;

      if (skillsDiv) {
        toggle.setAttribute('aria-expanded', String(!isExpanded));
        skillsDiv.classList.toggle('hidden');
      }
    });
  });
</script>

<!-- Mobile touch support -->
<script>
  // Progressive enhancement for mobile touch devices
  if ('ontouchstart' in window) {
    const cards = document.querySelectorAll('.skill-card-wrapper');

    cards.forEach(wrapper => {
      const card = wrapper.querySelector('.skill-card');
      if (!card) return;

      let isOpen = false;

      wrapper.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        // Close other cards
        cards.forEach(otherWrapper => {
          if (otherWrapper !== wrapper) {
            otherWrapper.setAttribute('aria-expanded', 'false');
            const otherCard = otherWrapper.querySelector('.skill-card');
            otherCard?.classList.remove('is-active');
          }
        });

        // Toggle current card
        isOpen = !isOpen;
        wrapper.setAttribute('aria-expanded', String(isOpen));
        card.classList.toggle('is-active', isOpen);
      });
    });

    // Close all on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.skill-card-wrapper')) {
        cards.forEach(wrapper => {
          wrapper.setAttribute('aria-expanded', 'false');
          const card = wrapper.querySelector('.skill-card');
          card?.classList.remove('is-active');
        });
      }
    });
  }
</script>

<!-- Keyboard navigation support -->
<script>
  const wrappers = document.querySelectorAll('.skill-card-wrapper');

  wrappers.forEach(wrapper => {
    const card = wrapper.querySelector('.skill-card');
    if (!card) return;

    wrapper.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const isExpanded = wrapper.getAttribute('aria-expanded') === 'true';

        // Close all other cards first
        wrappers.forEach(otherWrapper => {
          if (otherWrapper !== wrapper) {
            otherWrapper.setAttribute('aria-expanded', 'false');
            const otherCard = otherWrapper.querySelector('.skill-card');
            otherCard?.classList.remove('is-active');
          }
        });

        // Toggle current card
        wrapper.setAttribute('aria-expanded', String(!isExpanded));
        card.classList.toggle('is-active', !isExpanded);
      }

      if (e.key === 'Escape') {
        wrapper.setAttribute('aria-expanded', 'false');
        card.classList.remove('is-active');
      }
    });
  });
</script>
