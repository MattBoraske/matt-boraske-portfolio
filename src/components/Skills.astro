---
import { parseSkillsMarkdown } from '../utils/parseSkills';
import { resolve } from 'path';

interface CertificationInfo {
  url: string;
  issueDate: string;
  expirationDate: string;
}

const certifications: Record<string, CertificationInfo> = {
  'AWS Certified Cloud Practitioner': {
    url: 'https://www.credly.com/badges/46e41619-24db-44ac-a934-179ee232f007',
    issueDate: 'September 2025',
    expirationDate: 'September 2028',
  },
  'AWS Certified Solutions Architect â€“ Associate': {
    url: 'https://www.credly.com/badges/bb1da288-2923-4797-8560-4d26a12f6033/linked_in_profile',
    issueDate: 'September 2025',
    expirationDate: 'September 2028',
  },
  'Databricks Certified Machine Learning Associate': {
    url: 'https://credentials.databricks.com/c07a1146-9cc1-48b4-b9e2-d25c94c699c1',
    issueDate: 'September 2024',
    expirationDate: 'September 2026',
  },
};

// Parse skills.md at build time
const skillsPath = resolve('./src/resources/skills.md');
const categories = parseSkillsMarkdown(skillsPath);
---

<section id="skills" class="py-24 px-6 bg-bg-secondary">
  <div class="max-w-content mx-auto">
    <div class="section-header animate-on-scroll">
      <span class="header-bracket">[</span>
      <h2 class="text-3xl md:text-4xl font-bold text-text">Skills</h2>
      <span class="header-bracket">]</span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {categories.filter(({ name }) => name !== 'Certifications').map(({ name, icon, subsections }) => (
        <div
          class="skill-card-wrapper"
          role="button"
          tabindex="0"
          aria-expanded="false"
          aria-label={`${name} skills category`}
        >
          <!-- Category card with dropdown -->
          <div class="skill-card terminal-card group cursor-pointer h-full">
            <!-- Card header -->
            <div class="p-6 flex flex-col items-center gap-3">
              <i data-lucide={icon} class="w-10 h-10 text-accent skill-icon"></i>
              <h3 class="text-lg font-semibold text-text text-center font-display">{name}</h3>
              <p class="text-xs text-text-secondary opacity-70 font-mono terminal-hint">
                <span class="hint-bracket">&gt;</span> Hover to expand
              </p>
            </div>

            <!-- Dropdown panel -->
            {subsections.length > 0 && (
              <div class="skill-panel absolute top-full left-0 right-0 mt-2 p-4 bg-bg-secondary rounded border border-accent/30 shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-20 backdrop-blur-lg">
                <ul class="space-y-2 max-h-80 overflow-y-auto">
                  {subsections.map(({ name }) => (
                    <li class="text-sm text-text-secondary flex items-start gap-2 font-mono panel-item">
                      <span class="text-accent-hover mt-0.5">&gt;</span>
                      <span>{name}</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

<style>
  .section-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 3rem;
  }

  .header-bracket {
    font-family: var(--font-display);
    font-size: 3rem;
    color: var(--color-accent);
    font-weight: 900;
  }

  .skill-icon {
    filter: drop-shadow(0 0 10px var(--color-glow));
    transition: all 0.3s ease;
  }

  .skill-card:hover .skill-icon {
    transform: scale(1.1) rotateY(180deg);
    filter: drop-shadow(0 0 20px var(--color-glow));
  }

  .terminal-hint {
    transition: all 0.3s ease;
  }

  .hint-bracket {
    color: var(--color-accent);
    font-weight: 700;
  }

  .skill-card:hover .terminal-hint {
    color: var(--color-accent);
  }

  .skill-panel {
    box-shadow: 0 10px 40px rgba(0, 255, 255, 0.3);
  }

  .panel-item {
    transition: all 0.2s ease;
  }

  .panel-item:hover {
    color: var(--color-accent);
    padding-left: 0.5rem;
  }

  .skill-card-wrapper {
    position: relative;
  }

  .skill-card {
    position: relative;
    min-height: 200px;
  }

  /* Desktop: hover shows panel */
  @media (hover: hover) {
    .skill-card:hover {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
  }

  /* Mobile: click toggles .is-active class */
  @media (hover: none) {
    .skill-panel {
      opacity: 0 !important;
      visibility: hidden !important;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .skill-card.is-active .skill-panel {
      opacity: 1 !important;
      visibility: visible !important;
    }
  }

  /* Focus states for accessibility */
  .skill-card-wrapper:focus-within {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
    border-radius: 4px;
  }

  /* Ensure hovered/active cards appear above others */
  .skill-card-wrapper:hover,
  .skill-card-wrapper:focus-within,
  .skill-card-wrapper:has(.is-active) {
    z-index: 30;
  }

  /* Custom scrollbar for dropdown panels */
  .skill-panel {
    scrollbar-width: thin;
    scrollbar-color: var(--color-accent) transparent;
  }

  .skill-panel::-webkit-scrollbar {
    width: 6px;
  }

  .skill-panel::-webkit-scrollbar-track {
    background: transparent;
  }

  .skill-panel::-webkit-scrollbar-thumb {
    background-color: var(--color-accent);
    border-radius: 3px;
  }

  .skill-panel::-webkit-scrollbar-thumb:hover {
    background-color: var(--color-accent-hover);
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .skill-panel,
    .skill-card,
    .skill-icon {
      transition: none;
    }
  }

  /* Hide data-lucide elements until Lucide initializes them */
  [data-lucide]:not(.lucide) {
    opacity: 0.3;
  }
</style>

<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest" is:inline></script>
<script is:inline>
  lucide.createIcons();
</script>

<!-- Mobile touch support -->
<script>
  // Progressive enhancement for mobile touch devices
  if ('ontouchstart' in window) {
    const cards = document.querySelectorAll('.skill-card-wrapper');

    cards.forEach(wrapper => {
      const card = wrapper.querySelector('.skill-card');
      if (!card) return;

      let isOpen = false;

      wrapper.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        // Close other cards
        cards.forEach(otherWrapper => {
          if (otherWrapper !== wrapper) {
            otherWrapper.setAttribute('aria-expanded', 'false');
            const otherCard = otherWrapper.querySelector('.skill-card');
            otherCard?.classList.remove('is-active');
          }
        });

        // Toggle current card
        isOpen = !isOpen;
        wrapper.setAttribute('aria-expanded', String(isOpen));
        card.classList.toggle('is-active', isOpen);
      });
    });

    // Close all on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.skill-card-wrapper')) {
        cards.forEach(wrapper => {
          wrapper.setAttribute('aria-expanded', 'false');
          const card = wrapper.querySelector('.skill-card');
          card?.classList.remove('is-active');
        });
      }
    });
  }
</script>

<!-- Keyboard navigation support -->
<script>
  const wrappers = document.querySelectorAll('.skill-card-wrapper');

  wrappers.forEach(wrapper => {
    const card = wrapper.querySelector('.skill-card');
    if (!card) return;

    wrapper.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const isExpanded = wrapper.getAttribute('aria-expanded') === 'true';

        // Close all other cards first
        wrappers.forEach(otherWrapper => {
          if (otherWrapper !== wrapper) {
            otherWrapper.setAttribute('aria-expanded', 'false');
            const otherCard = otherWrapper.querySelector('.skill-card');
            otherCard?.classList.remove('is-active');
          }
        });

        // Toggle current card
        wrapper.setAttribute('aria-expanded', String(!isExpanded));
        card.classList.toggle('is-active', !isExpanded);
      }

      if (e.key === 'Escape') {
        wrapper.setAttribute('aria-expanded', 'false');
        card.classList.remove('is-active');
      }
    });
  });
</script>

<style>
  .skill-card-wrapper {
    position: relative;
  }

  .skill-card {
    position: relative;
    min-height: 180px;
  }

  .skill-panel {
    max-height: 300px;
  }

  /* Desktop: hover shows panel */
  @media (hover: hover) {
    .skill-card:hover {
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
  }

  /* Mobile: click toggles .is-active class */
  @media (hover: none) {
    .skill-panel {
      opacity: 0 !important;
      visibility: hidden !important;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .skill-card.is-active .skill-panel {
      opacity: 1 !important;
      visibility: visible !important;
    }
  }

  /* Focus states for accessibility */
  .skill-card-wrapper:focus-within {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
    border-radius: 0.75rem;
  }

  /* Ensure hovered/active cards appear above others */
  .skill-card-wrapper:hover,
  .skill-card-wrapper:focus-within,
  .skill-card-wrapper:has(.is-active) {
    z-index: 30;
  }

  /* Custom scrollbar for dropdown panels */
  .skill-panel {
    scrollbar-width: thin;
    scrollbar-color: var(--color-border) transparent;
  }

  .skill-panel::-webkit-scrollbar {
    width: 6px;
  }

  .skill-panel::-webkit-scrollbar-track {
    background: transparent;
  }

  .skill-panel::-webkit-scrollbar-thumb {
    background-color: var(--color-border);
    border-radius: 3px;
  }

  .skill-panel::-webkit-scrollbar-thumb:hover {
    background-color: var(--color-accent);
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .skill-panel,
    .skill-card {
      transition: none;
    }
  }

  /* Hide data-lucide elements until Lucide initializes them */
  [data-lucide]:not(.lucide) {
    opacity: 0.3;
  }
</style>
